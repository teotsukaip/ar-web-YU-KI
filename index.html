<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MindAR マーカー音声再生アプリ</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: #000;
        }
        
        #info {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 8px;
            z-index: 1000;
            font-size: 14px;
            max-width: 300px;
        }
        
        #status {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 8px;
            z-index: 1000;
            font-size: 14px;
        }
        
        #instructions {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 20px;
            border-radius: 10px;
            z-index: 1001;
            text-align: center;
            max-width: 400px;
        }
        
        .hidden {
            display: none;
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <div id="instructions">
        <h3>MindAR マーカー音声再生アプリ</h3>
        <p>このアプリはカメラを使用してYU-KI画像マーカーを検出し、音声を再生します。</p>
        <p>カメラアクセスを許可してください。</p>
        <button onclick="startAR()">カメラを開始</button>
        <button onclick="showMarkerInfo()">マーカー情報</button>
    </div>
    
    <div id="info" class="hidden">
        カメラでYU-KI画像マーカーを認識してください
    </div>
    
    <div id="status" class="hidden">
        ステータス: 初期化中
    </div>
    
    <a-scene
        id="arScene"
        class="hidden"
        mindar-image="imageTargetSrc: ./YU-KI.mind; autoStart: false; uiLoading: no; uiScanning: no; uiError: no;"
        color-space="sRGB"
        renderer="colorManagement: true, physicallyCorrectLights"
        vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: false">
        
        <a-assets>
            <audio id="audioClip" src="output_clip.mp3" preload="auto"></audio>
        </a-assets>
        
        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
        
        <a-entity mindar-image-target="targetIndex: 0">
            <a-box
                position="0 0 0"
                material="color: #00ff00; opacity: 0.0"
                scale="0.01 0.01 0.01"
                visible="false">
            </a-box>
        </a-entity>
    </a-scene>
    
    <script>
        let isPlaying = false;
        let audioElement = null;
        let statusElement = null;
        let infoElement = null;
        let instructionsElement = null;
        let arScene = null;
        let cameraStarted = false;
        let markerTarget = null;
        
        document.addEventListener('DOMContentLoaded', function() {
            audioElement = document.getElementById('audioClip');
            statusElement = document.getElementById('status');
            infoElement = document.getElementById('info');
            instructionsElement = document.getElementById('instructions');
            arScene = document.getElementById('arScene');
            markerTarget = document.querySelector('a-entity[mindar-image-target]');
            
            setupEventListeners();
        });
        
        function setupEventListeners() {
            if (markerTarget) {
                markerTarget.addEventListener('targetFound', function() {
                    console.log('YU-KI画像マーカーが検出されました');
                    if (statusElement) {
                        statusElement.textContent = 'ステータス: マーカー検出 - 音声再生中';
                    }
                    
                    if (!isPlaying && audioElement) {
                        playAudio();
                    }
                });
                
                markerTarget.addEventListener('targetLost', function() {
                    console.log('YU-KI画像マーカーが見失われました');
                    if (statusElement) {
                        statusElement.textContent = 'ステータス: マーカー未検出';
                    }
                });
            }
            
            if (audioElement) {
                audioElement.addEventListener('ended', function() {
                    console.log('音声再生終了');
                    isPlaying = false;
                    if (statusElement) {
                        statusElement.textContent = 'ステータス: 待機中';
                    }
                });
                
                audioElement.addEventListener('error', function(e) {
                    console.error('音声ファイルエラー:', e);
                    isPlaying = false;
                    if (statusElement) {
                        statusElement.textContent = 'ステータス: 音声ファイルエラー';
                    }
                });
            }
            
            arScene.addEventListener('arReady', function() {
                console.log('MindAR初期化完了');
                if (statusElement) {
                    statusElement.textContent = 'ステータス: YU-KI画像マーカーを画面中央に配置してください';
                }
            });
            
            arScene.addEventListener('arError', function(event) {
                console.error('MindARエラー:', event.detail.error);
                if (statusElement) {
                    statusElement.textContent = 'ステータス: ARエラー - ' + event.detail.error;
                }
            });
        }
        
        function playAudio() {
            if (isPlaying || !audioElement) return;
            
            isPlaying = true;
            console.log('音声再生開始');
            
            // Reset audio to beginning
            audioElement.currentTime = 0;
            
            // Ensure audio is loaded
            if (audioElement.readyState < 2) {
                audioElement.load();
            }
            
            // Try to play audio
            const playPromise = audioElement.play();
            
            if (playPromise !== undefined) {
                playPromise.then(() => {
                    console.log('音声再生成功');
                    if (statusElement) {
                        statusElement.textContent = 'ステータス: YU-KI画像マーカー検出成功！音声再生中...';
                    }
                }).catch((error) => {
                    console.error('音声再生エラー:', error);
                    isPlaying = false;
                    if (statusElement) {
                        statusElement.textContent = 'ステータス: 音声再生エラー - ' + error.message;
                    }
                    
                    // Try alternative approach - create new audio element
                    tryAlternativeAudioPlay();
                });
            }
        }
        
        function tryAlternativeAudioPlay() {
            try {
                // Create new audio element as fallback
                const newAudio = new Audio('output_clip.mp3');
                newAudio.preload = 'auto';
                newAudio.volume = 1.0;
                
                newAudio.addEventListener('ended', function() {
                    console.log('代替音声再生終了');
                    isPlaying = false;
                    if (statusElement) {
                        statusElement.textContent = 'ステータス: 待機中';
                    }
                });
                
                newAudio.addEventListener('error', function(e) {
                    console.error('代替音声再生エラー:', e);
                    isPlaying = false;
                    if (statusElement) {
                        statusElement.textContent = 'ステータス: 音声ファイルが見つかりません';
                    }
                });
                
                const playPromise = newAudio.play();
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        console.log('代替音声再生成功');
                        if (statusElement) {
                            statusElement.textContent = 'ステータス: 音声再生中（代替方式）';
                        }
                    }).catch((error) => {
                        console.error('代替音声再生失敗:', error);
                        isPlaying = false;
                        if (statusElement) {
                            statusElement.textContent = 'ステータス: 音声再生不可 - ブラウザ制限';
                        }
                    });
                }
            } catch (error) {
                console.error('代替音声作成エラー:', error);
                isPlaying = false;
                if (statusElement) {
                    statusElement.textContent = 'ステータス: 音声システムエラー';
                }
            }
        }
        
        function startAR() {
            if (cameraStarted) return;
            
            // Enable audio playback by user interaction
            if (audioElement) {
                audioElement.muted = false;
                audioElement.volume = 1.0;
                // Try to load the audio file
                audioElement.load();
            }
            
            instructionsElement.classList.add('hidden');
            arScene.classList.remove('hidden');
            infoElement.classList.remove('hidden');
            statusElement.classList.remove('hidden');
            
            statusElement.textContent = 'ステータス: MindAR初期化中...';
            cameraStarted = true;
            
            const mindARSystem = arScene.systems['mindar-image-system'];
            mindARSystem.start();
        }
        
        function showMarkerInfo() {
            alert('このアプリはYU-KI.jpg画像をマーカーとして使用します。\n\nYU-KI画像マーカーをカメラに向けると音声が再生されます。\n\n音声再生が終了すると、再度マーカーを認識するまで音声は再生されません。\n\n【YU-KI画像マーカー検出のコツ】\n・画像を画面中央に配置\n・適度な距離（20-40cm）を保つ\n・十分な照明を確保\n・画像を平らに保つ\n・画像全体がカメラに映るようにする\n・白い背景の上に画像を置く\n・ゆっくりと動かして角度を調整');
        }
        
        document.addEventListener('keydown', function(event) {
            if (event.key === 't' || event.key === 'T') {
                console.log('テスト: マーカー検出シミュレート');
                if (!isPlaying && audioElement) {
                    playAudio();
                }
            }
        });
    </script>
</body>
</html>
